import re
import sys

import pandas as pd


def filter_cve(EXPLOITDB_string: str):
    """ Use for the EXPLOITDB_cve_extract() """
    """ Used to filter string data from textualDescription from ExploitDB data """
    
    EXPLOITDB_string = EXPLOITDB_string.replace('CVE: ','CVE-')
    EXPLOITDB_string = EXPLOITDB_string.replace('CVE-CVE-','CVE-')

    matches = re.search(r"CVE-\d{4}-\d{4,7}", EXPLOITDB_string)
    cve_id = matches.group()
    return cve_id


def extract(app_config: dict):
    """ Enrich CVE data with exploit data from ExploitDB SearchSploit """
    
    print("\n***** Beginning data enrichment with ExploitDB SearchSploit data *****\n")
    
    searchsploit_xml_path = app_config["EXPLOITDB_DIR"]+app_config["EXPLOITDB_XML_FILE"]
    searchsploit_excel_path = app_config["EXPLOITDB_DIR"]+app_config["EXPLOITDB_EXCEL_FILE"]
    EXPLOITDB_EXCLUSION_WORDS = app_config["EXPLOITDB_EXCLUSION_WORDS"]
    
    try:
        print(f"Attempting to process: {searchsploit_xml_path}")    
        searchsploit_df = pd.read_xml(searchsploit_xml_path, parser="etree")
        filtered_searchsploit_df = searchsploit_df[["id","link","edb","textualDescription"]]

        # Print out complete XML database to an Excel file
        # filtered_searchsploit_df.to_excel("./data/exploitdb/ghdb_total.xlsx")
        
        searchsploit_cve_with_dorks_df = filtered_searchsploit_df[filtered_searchsploit_df["textualDescription"].str.contains('CVE:')]
        searchsploit_cve_with_dorks_df = searchsploit_cve_with_dorks_df.dropna()
        
        for word in EXPLOITDB_EXCLUSION_WORDS:
            searchsploit_cve_with_dorks_df = searchsploit_cve_with_dorks_df[~searchsploit_cve_with_dorks_df["textualDescription"].str.contains(word)]

        searchsploit_cve_with_dorks_df["cve_id"] = searchsploit_cve_with_dorks_df["textualDescription"].apply(filter_cve)
        searchsploit_cve_only_df = searchsploit_cve_with_dorks_df.drop('textualDescription', axis=1)

    except Exception as e:
        sys.exit(f"Unable to process ExploitDB file with error: {e}")
    else:
        print(f"Extracted all CVE data from file: {searchsploit_xml_path}")
        try:
            searchsploit_cve_only_df.to_excel(searchsploit_excel_path)
        except Exception as e:
            sys.exit(f"Error writing Excel file to: {searchsploit_excel_path}")
        else:
            print(f"Excel file written to: {searchsploit_excel_path}")

          
if __name__ == "__main__":
    import config
    app_config, user_config = config.bootstrap()
    extract(app_config)